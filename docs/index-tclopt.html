<!DOCTYPE html><html><head><meta charset="utf-8"/>
<title>Tcl wrapper for C optimization procedures</title>
<link rel='stylesheet' type='text/css' href='assets/ruff-min.css' />
<script type='text/javascript' src='assets/ruff-min.js'></script>
</head>
<body>
<div class='ruff-layout'>
<header class='ruff-layout-header ruff-hd'>
<a style='text-decoration:none;' href='index.html'>Tcl wrapper for C optimization procedures (v0.1)</a>


            <div id="ruffButtonBar">
            <button id="ruffNavMove" onclick="ruffMoveNavPane()"></button>
            <button id="ruffToggleTheme" onclick="ruffNextTheme()"></button>
            </div>
        </header><main class='ruff-layout-main ruff-bd'><h1 class='ruff'><a name='::tclopt'></a>::tclopt<span class='ruff-uplink'><a href='#top'>Top</a>, <a href='index.html'>Main</a>, <a href='index-docindex.html#'>Index</a></span></h1>
<div style='clear:both;'></div>
<h2 class='ruff'><a name='::tclopt-Commands'></a>Commands<span class='ruff-uplink'><a href='#top'>Top</a>, <a href='index.html'>Main</a>, <a href='index-docindex.html#'>Index</a></span></h2>
<div style='clear:both;'></div>
<h3 class='ruffproc'><a name='::tclopt::mpfit'>mpfit</a><span class='ns_scope'> [<a href="index-tclopt.html#::tclopt" title="::tclopt" class='ruff_cmd'>::tclopt</a>]</span><span class='ruff-uplink'><a href='#top'>Top</a>, <a href='index.html'>Main</a>, <a href='index-docindex.html#'>Index</a></span></h3>
<div style='clear:both;'></div>
<p class='ruff'>Does least squares fitting using modified Levenberg-Marquardt algorithm.</p>
<div class='ruff_synopsis'><span class='ruff_cmd'>mpfit</span> <span class='ruff_arg'>-funct value -m value -xall list -pdata value ?-pars list? ?-ftol value? ?-xtol value? ?-gtol value? ?-stepfactor value? ?-covtol value? ?-maxiter value? ?-maxfev value? ?-epsfcn value? ?-nofinitecheck?</span></div>
<h5 class='ruff'>Parameters</h5><table class='ruff_deflist'>
<tr><td><code><font color=#b9b96e>-covtol</font></code></td><td>Range tolerance for covariance calculation. Value must be of the type float more than zero, default is 1e-14.</td></tr>
<tr><td><code><font color=#b9b96e>-epsfcn</font></code></td><td>Finite derivative step size. Value must be of the type float more than zero, default is 2.2204460e-16.</td></tr>
<tr><td><code><font color=#b9b96e>-ftol</font></code></td><td>Control termination of mpfit. Termination occurs when both the actual and predicted relative reductions in the sum of squares are at most ftol. Therefore, ftol measures the relative error desired in the sum of squares. Value must be of the type float more than zero, default is 1e-10.</td></tr>
<tr><td><code><font color=#b9b96e>-funct</font></code></td><td>Name of the procedure that should be minimized.</td></tr>
<tr><td><code><font color=#b9b96e>-gtol</font></code></td><td>Control termination of mpfit. Termination occurs when the cosine of the angle between fvec and any column of the jacobian is at most gtol in absolute value. Therefore, gtol measures the orthogonality desired between the function vector and the columns of the jacobian. Value must be of the type float more than zero, default is 1e-10.</td></tr>
<tr><td><code><font color=#b9b96e>-m</font></code></td><td>Number of data points.</td></tr>
<tr><td><code><font color=#b9b96e>-maxfev</font></code></td><td>Control termination of mpfit. Termination occurs when the number of calls to funct is at least maxfev by the end of an iteration. Value must be the positive integer, default is 0. If it equals to 0, number of evaluations is not restricted.</td></tr>
<tr><td><code><font color=#b9b96e>-maxiter</font></code></td><td>Maximum number of iterations. If maxiter equal to 0, then basic error checking is done, and parameter errors/covariances are estimated based on input arameter values, but no fitting iterations are done. Value must be the positive integer, default is 200.</td></tr>
<tr><td><code><font color=#b9b96e>-nofinitecheck</font></code></td><td>Enable check for infinite quantities, default is off.</td></tr>
<tr><td><code><font color=#b9b96e>-pars</font></code></td><td>List of npar dictionaries specifying constraints, length must be equal to length of xall if provided, optional. To specify the dictionary of the right form, use helper procedure ::tclopt::parCreate.</td></tr>
<tr><td><code><font color=#b9b96e>-pdata</font></code></td><td>List or dictionary that provides private data to funct that is needed to evaluate residuals. Usually it contains x and y values lists, but you can provide any data necessary for function residuals evaluation. Will be passed upon each function evaluation without modification.</td></tr>
<tr><td><code><font color=#b9b96e>-stepfactor</font></code></td><td>Used in determining the initial step bound. This bound is set to the product of factor and the euclidean norm of diag*x if nonzero, or else to factor itself. in most cases factor should lie in the interval (.1,100.). 100. is a generally recommended value. Value must be of the type float more than zero, default is 100.</td></tr>
<tr><td><code><font color=#b9b96e>-xall</font></code></td><td>List of n initial parameter values.</td></tr>
<tr><td><code><font color=#b9b96e>-xtol</font></code></td><td>Control termination of mpfit. Termination occurs when the relative error between two consecutive iterates is at most xtol. Therefore, xtol measures the relative error desired in the approximate solution. Value must be of the type float more than zero, default is 1e-10.</td></tr>
</table>
<h5 class='ruff'>Description</h5><p class='ruff'>Procedure uses the Levenberg-Marquardt technique to solve the least-squares problem. In its typical use, it will be used to fit a user-supplied function (the &quot;model&quot;) to user-supplied data points (the &quot;data&quot;) by adjusting a set of parameters. mpfit is based upon MINPACK-1 (LMDIF.F) by More' and collaborators. The user-supplied function should compute an array of weighted deviations between model and data. In a typical scientific problem the residuals should be weighted so that each deviate has a gaussian sigma of 1.0. If x represents values of the independent variable, y represents a measurement for each value of x, and err represents the error in the measurements, then the deviates could be calculated as follows:</p>

<figure  class='ruff-snippet ruff-figure'><pre class='ruff'><b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
    <b><font color=#ffa500>lset</font></b> deviates <font color=#f1b479>$i</font> [<b><font color=#ffa500>expr</font></b> {([<b><font color=#ffa500>lindex</font></b> <font color=#f1b479>$y</font> <font color=#f1b479>$i</font>] - [f [<b><font color=#ffa500>lindex</font></b> <font color=#f1b479>$x</font> <font color=#f1b479>$i</font>]])/[<b><font color=#ffa500>lindex</font></b> <font color=#f1b479>$err</font> <font color=#f1b479>$i</font>]}]
}
</pre>

</figure><p class='ruff'>where m is the number of data points, and where f is the function representing the model evaluated at x. If ERR are the 1-sigma uncertainties in Y, then the sum of deviates squared will be the total chi-squared value, which mpfit will seek to minimize. Simple constraints can be placed on parameter values by using the <code>pars</code> parameter to mpfit, and other parameter-specific options can be set. The right dictionary should be generated using <a href="index-tclopt.html#::tclopt::parCreate" title="parCreate" class='ruff_cmd'>parCreate</a> procedure, and the elements of the <code>pars</code> list must be provided in the same order as parameters in <code>xall</code> list, for example, if <code>xall</code> is <code>{par0initVal par1initVal par2initVal}</code>. <code>pars</code> list must be of the form <code>{par0constrDict par1constrDict par2constrDict}</code>. For details of how to specify constraints, please look at the description of <a href="index-tclopt.html#::tclopt::parCreate" title="parCreate" class='ruff_cmd'>parCreate</a> procedure. Example of user defined function (using linear equation t=a+b*x):</p>

<figure  class='ruff-snippet ruff-figure'><pre class='ruff'><b><font color=#fe6efe>proc</font></b> f {xall pdata args} {
    <b><font color=#ffa500>set</font></b> x [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> x]
    <b><font color=#ffa500>set</font></b> y [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> y]
    <b><font color=#ffa500>set</font></b> ey [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> ey]
    <b><font color=#ffa500>foreach</font></b> xVal <font color=#f1b479>$x</font> yVal <font color=#f1b479>$y</font> eyVal <font color=#f1b479>$ey</font> {
        <b><font color=#ffa500>set</font></b> f [= {[@ <font color=#f1b479>$xall</font> 0]+[@ <font color=#f1b479>$xall</font> 1]*<font color=#f1b479>$xVal</font>}]
        <b><font color=#ffa500>lappend</font></b> fval [= {(<font color=#f1b479>$yVal</font>-<font color=#f1b479>$f</font>)/<font color=#f1b479>$eyVal</font>}]
    }
    <b><font color=#fe6efe>return</font></b> [<b><font color=#ffa500>dcreate</font></b> fvec <font color=#f1b479>$fval</font>]
}
</pre>

</figure><p class='ruff'>where xall is list of initial parameters values, pdata - dictionary that contains x, y and ey lists with length m. It returns dictionary with residuals values. Alternative form of function f could also provide analytical derivatives:</p>

<figure  class='ruff-snippet ruff-figure'><pre class='ruff'><b><font color=#fe6efe>proc</font></b> quadfunc {xall pdata args} {
    <b><font color=#ffa500>set</font></b> x [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> x]
    <b><font color=#ffa500>set</font></b> y [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> y]
    <b><font color=#ffa500>set</font></b> ey [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$pdata</font> ey]
    <b><font color=#ffa500>foreach</font></b> xVal <font color=#f1b479>$x</font> yVal <font color=#f1b479>$y</font> eyVal <font color=#f1b479>$ey</font> {
        <b><font color=#ffa500>lappend</font></b> fvec [= {(<font color=#f1b479>$yVal</font>-[@ <font color=#f1b479>$xall</font> 0]-[@ <font color=#f1b479>$xall</font> 1]*<font color=#f1b479>$xVal</font>-[@ <font color=#f1b479>$xall</font> 2]*<font color=#f1b479>$xVal</font>*<font color=#f1b479>$xVal</font>)/<font color=#f1b479>$eyVal</font>}]
    }
    <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$args</font> 0]!=<font color=#90ee90>&quot;&quot;</font>} {
        <b><font color=#ffa500>set</font></b> derivs [@ <font color=#f1b479>$args</font> 0]
        <b><font color=#ffa500>foreach</font></b> deriv <font color=#f1b479>$derivs</font> {
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$deriv</font>==0} {
                <b><font color=#ffa500>foreach</font></b> xVal <font color=#f1b479>$x</font> yVal <font color=#f1b479>$y</font> eyVal <font color=#f1b479>$ey</font> {
                    <b><font color=#ffa500>lappend</font></b> dvec [= {-1/<font color=#f1b479>$eyVal</font>}]
                }
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$deriv</font>==1} {
                <b><font color=#ffa500>foreach</font></b> xVal <font color=#f1b479>$x</font> yVal <font color=#f1b479>$y</font> eyVal <font color=#f1b479>$ey</font> {
                    <b><font color=#ffa500>lappend</font></b> dvec [= {(-<font color=#f1b479>$xVal</font>)/<font color=#f1b479>$eyVal</font>}]
                }
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$deriv</font>==2} {
                <b><font color=#ffa500>foreach</font></b> xVal <font color=#f1b479>$x</font> yVal <font color=#f1b479>$y</font> eyVal <font color=#f1b479>$ey</font> {
                    <b><font color=#ffa500>lappend</font></b> dvec [= {(-<font color=#f1b479>$xVal</font>*<font color=#f1b479>$xVal</font>)/<font color=#f1b479>$eyVal</font>}]
                }
            }
        }
        <b><font color=#fe6efe>return</font></b> [<b><font color=#ffa500>dcreate</font></b> fvec <font color=#f1b479>$fvec</font> dvec <font color=#f1b479>$dvec</font>]
    } <b><font color=#ffa500>else</font></b> {
        <b><font color=#fe6efe>return</font></b> [<b><font color=#ffa500>dcreate</font></b> fvec <font color=#f1b479>$fvec</font>]
    }
}
</pre>

</figure><p class='ruff'>The first element of the <code>args</code> list is a list specifying the ordinal numbers of the parameters for which we need to calculate the analytical derivative. In this case, the returned <code>dvec</code> list contains the derivative at each x point for each specified parameter, following the same order as in the input list. For example, if the input list is {0, 2} and the number m of x points is 3, the <code>dvec</code> list will look like this:</p>

<figure  class='ruff-snippet ruff-figure'><pre class='ruff'>⎛⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞  ⎞
⎜⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟  ⎟
⎜⎝dp0⎠   ⎝dp0⎠   ⎝dp0⎠   ⎝dp2⎠   ⎝dp2⎠   ⎝dp2⎠  ⎟
⎝     x0      x1      x2      x0      x1      x2⎠
</pre>

</figure><p class='ruff'>Description of keys and data in returned dictionary:</p>
<table class='ruff_deflist'>
<tr><td>-bestnorm</td><td>Final chi^2.</td></tr>
<tr><td>-orignorm</td><td>Starting value of chi^2.</td></tr>
<tr><td>-status</td><td>Fitting status code.</td></tr>
<tr><td>-niter</td><td>Number of iterations.</td></tr>
<tr><td>-nfev</td><td>Number of function evaluations.</td></tr>
<tr><td>-npar</td><td>Total number of parameters.</td></tr>
<tr><td>-nfree</td><td>Number of free parameters.</td></tr>
<tr><td>-npegged</td><td>Number of pegged parameters.</td></tr>
<tr><td>-nfunc</td><td>Number of residuals (= num. of data points)</td></tr>
<tr><td>-resid</td><td>List of final residuals.</td></tr>
<tr><td>-xerror</td><td>Final parameter uncertainties (1-sigma),</td></tr>
<tr><td>-x</td><td>Final parameters values list.</td></tr>
<tr><td>-debug</td><td>String with derivatives debugging output.</td></tr>
<tr><td>-covar</td><td>Final parameters covariance matrix.</td></tr>
</table>
<h5 class='ruff'>Return value</h5><p class='ruff'>dictionary with keya/data described above</p>
<div class='ruff_source'><p class='ruff_source_link'><a id='l_tclopt_mpfit' href="javascript:toggleSource('tclopt_mpfit')">Show source</a></p>
<div id='tclopt_mpfit' class='ruff_dyn_src'><pre><b><font color=#fe6efe>proc</font></b> ::tclopt::mpfit {args} {

    <i><font color=#76a396># Does least squares fitting using modified Levenberg-Marquardt algorithm.</font></i>
    <i><font color=#76a396>#  -funct - name of the procedure that should be minimized</font></i>
    <i><font color=#76a396>#  -m - number of data points</font></i>
    <i><font color=#76a396>#  -xall - list of n initial parameter values</font></i>
    <i><font color=#76a396>#  -pars - list of npar dictionaries specifying constraints, length must be equal to length of xall if provided,</font></i>
    <i><font color=#76a396>#    optional. To specify the dictionary of the right form, use helper procedure ::tclopt::parCreate.</font></i>
    <i><font color=#76a396>#  -pdata - list or dictionary that provides private data to funct that is needed to evaluate residuals. Usually</font></i>
    <i><font color=#76a396>#    it contains x and y values lists, but you can provide any data necessary for function residuals evaluation.</font></i>
    <i><font color=#76a396>#    Will be passed upon each function evaluation without modification.</font></i>
    <i><font color=#76a396>#  -ftol - control termination of mpfit. Termination occurs when both the actual and predicted relative</font></i>
    <i><font color=#76a396>#    reductions in the sum of squares are at most ftol. Therefore, ftol measures the relative error desired</font></i>
    <i><font color=#76a396>#    in the sum of squares. Value must be of the type float more than zero, default is 1e-10.</font></i>
    <i><font color=#76a396>#  -xtol - control termination of mpfit. Termination occurs when the relative error between two consecutive iterates</font></i>
    <i><font color=#76a396>#    is at most xtol. Therefore, xtol measures the relative error desired in the approximate solution.</font></i>
    <i><font color=#76a396>#    Value must be of the type float more than zero, default is 1e-10.</font></i>
    <i><font color=#76a396>#  -gtol - control termination of mpfit. Termination occurs when the cosine of the angle between fvec and any</font></i>
    <i><font color=#76a396>#    column of the jacobian is at most gtol in absolute value. Therefore, gtol measures the orthogonality desired</font></i>
    <i><font color=#76a396>#    between the function vector and the columns of the jacobian. Value must be of the type float more than zero,</font></i>
    <i><font color=#76a396>#    default is 1e-10.</font></i>
    <i><font color=#76a396>#  -maxfev - control termination of mpfit. Termination occurs when the number of calls to funct is at least</font></i>
    <i><font color=#76a396>#    maxfev by the end of an iteration. Value must be the positive integer, default is 0. If it equals to 0,</font></i>
    <i><font color=#76a396>#    number of evaluations is not restricted.</font></i>
    <i><font color=#76a396>#  -stepfactor - used in determining the initial step bound. This bound is set to the product of factor and the</font></i>
    <i><font color=#76a396>#    euclidean norm of diag*x if nonzero, or else to factor itself. in most cases factor should lie in the interval</font></i>
    <i><font color=#76a396>#    (.1,100.). 100. is a generally recommended value. Value must be of the type float more than zero, default is</font></i>
    <i><font color=#76a396>#    100.</font></i>
    <i><font color=#76a396>#  -covtol - range tolerance for covariance calculation. Value must be of the type float more than zero, default is</font></i>
    <i><font color=#76a396>#    1e-14.</font></i>
    <i><font color=#76a396>#  -maxiter - maximum number of iterations. If maxiter equal to 0, then basic error checking is done, and parameter</font></i>
    <i><font color=#76a396>#    errors/covariances are estimated based on input arameter values, but no fitting iterations are done.</font></i>
    <i><font color=#76a396>#    Value must be the positive integer, default is 200.</font></i>
    <i><font color=#76a396>#  -epsfcn - finite derivative step size. Value must be of the type float more than zero, default is 2.2204460e-16.</font></i>
    <i><font color=#76a396>#  -nofinitecheck - enable check for infinite quantities, default is off.</font></i>
    <i><font color=#76a396># Returns: dictionary with keya/data described above</font></i>
    <i><font color=#76a396>#</font></i>
    <i><font color=#76a396># Procedure uses the Levenberg-Marquardt technique to solve the least-squares problem. In its typical use, it will</font></i>
    <i><font color=#76a396># be used to fit a user-supplied function (the &quot;model&quot;) to user-supplied data points (the &quot;data&quot;) by adjusting a set</font></i>
    <i><font color=#76a396># of parameters. mpfit is based upon MINPACK-1 (LMDIF.F) by More' and collaborators.</font></i>
    <i><font color=#76a396># The user-supplied function should compute an array of weighted deviations between model and data. In a typical</font></i>
    <i><font color=#76a396># scientific problem the residuals should be weighted so that each deviate has a gaussian sigma of 1.0. If x</font></i>
    <i><font color=#76a396># represents values of the independent variable, y represents a measurement for each value of x, and err represents</font></i>
    <i><font color=#76a396># the error in the measurements, then the deviates could be calculated as follows:</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># for {set i 0} {$i&lt;$m} {incr i} {</font></i>
    <i><font color=#76a396>#     lset deviates $i [expr {([lindex $y $i] - [f [lindex $x $i]])/[lindex $err $i]}]</font></i>
    <i><font color=#76a396># }</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># where m is the number of data points, and where f is the function representing the model evaluated at x. If ERR</font></i>
    <i><font color=#76a396># are the 1-sigma uncertainties in Y, then the sum of deviates squared will be the total chi-squared value, which</font></i>
    <i><font color=#76a396># mpfit will seek to minimize.</font></i>
    <i><font color=#76a396># Simple constraints can be placed on parameter values by using the `pars` parameter to mpfit, and other</font></i>
    <i><font color=#76a396># parameter-specific options can be set. The right dictionary should be generated using [::tclopt::parCreate]</font></i>
    <i><font color=#76a396># procedure, and the elements of the `pars` list must be provided in the same order as parameters in `xall` list,</font></i>
    <i><font color=#76a396># for example, if `xall` is `{par0initVal par1initVal par2initVal}`. `pars` list must be of the form</font></i>
    <i><font color=#76a396># `{par0constrDict par1constrDict par2constrDict}`. For details of how to specify constraints, please look at the</font></i>
    <i><font color=#76a396># description of [::tclopt::parCreate] procedure.</font></i>
    <i><font color=#76a396># Example of user defined function (using linear equation t=a+b*x):</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># proc f {xall pdata args} {</font></i>
    <i><font color=#76a396>#     set x [dget $pdata x]</font></i>
    <i><font color=#76a396>#     set y [dget $pdata y]</font></i>
    <i><font color=#76a396>#     set ey [dget $pdata ey]</font></i>
    <i><font color=#76a396>#     foreach xVal $x yVal $y eyVal $ey {</font></i>
    <i><font color=#76a396>#         set f [= {[@ $xall 0]+[@ $xall 1]*$xVal}]</font></i>
    <i><font color=#76a396>#         lappend fval [= {($yVal-$f)/$eyVal}]</font></i>
    <i><font color=#76a396>#     }</font></i>
    <i><font color=#76a396>#     return [dcreate fvec $fval]</font></i>
    <i><font color=#76a396># }</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># where xall is list of initial parameters values, pdata - dictionary that contains x, y and ey lists with length m.</font></i>
    <i><font color=#76a396># It returns dictionary with residuals values.</font></i>
    <i><font color=#76a396># Alternative form of function f could also provide analytical derivatives:</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># proc quadfunc {xall pdata args} {</font></i>
    <i><font color=#76a396>#     set x [dget $pdata x]</font></i>
    <i><font color=#76a396>#     set y [dget $pdata y]</font></i>
    <i><font color=#76a396>#     set ey [dget $pdata ey]</font></i>
    <i><font color=#76a396>#     foreach xVal $x yVal $y eyVal $ey {</font></i>
    <i><font color=#76a396>#         lappend fvec [= {($yVal-[@ $xall 0]-[@ $xall 1]*$xVal-[@ $xall 2]*$xVal*$xVal)/$eyVal}]</font></i>
    <i><font color=#76a396>#     }</font></i>
    <i><font color=#76a396>#     if {[@ $args 0]!=&quot;&quot;} {</font></i>
    <i><font color=#76a396>#         set derivs [@ $args 0]</font></i>
    <i><font color=#76a396>#         foreach deriv $derivs {</font></i>
    <i><font color=#76a396>#             if {$deriv==0} {</font></i>
    <i><font color=#76a396>#                 foreach xVal $x yVal $y eyVal $ey {</font></i>
    <i><font color=#76a396>#                     lappend dvec [= {-1/$eyVal}]</font></i>
    <i><font color=#76a396>#                 }</font></i>
    <i><font color=#76a396>#             }</font></i>
    <i><font color=#76a396>#             if {$deriv==1} {</font></i>
    <i><font color=#76a396>#                 foreach xVal $x yVal $y eyVal $ey {</font></i>
    <i><font color=#76a396>#                     lappend dvec [= {(-$xVal)/$eyVal}]</font></i>
    <i><font color=#76a396>#                 }</font></i>
    <i><font color=#76a396>#             }</font></i>
    <i><font color=#76a396>#             if {$deriv==2} {</font></i>
    <i><font color=#76a396>#                 foreach xVal $x yVal $y eyVal $ey {</font></i>
    <i><font color=#76a396>#                     lappend dvec [= {(-$xVal*$xVal)/$eyVal}]</font></i>
    <i><font color=#76a396>#                 }</font></i>
    <i><font color=#76a396>#             }</font></i>
    <i><font color=#76a396>#         }</font></i>
    <i><font color=#76a396>#         return [dcreate fvec $fvec dvec $dvec]</font></i>
    <i><font color=#76a396>#     } else {</font></i>
    <i><font color=#76a396>#         return [dcreate fvec $fvec]</font></i>
    <i><font color=#76a396>#     }</font></i>
    <i><font color=#76a396># }</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># The first element of the `args` list is a list specifying the ordinal numbers of the parameters for which we need to</font></i>
    <i><font color=#76a396># calculate the analytical derivative. In this case, the returned `dvec` list contains the derivative at each x point</font></i>
    <i><font color=#76a396># for each specified parameter, following the same order as in the input list. For example, if the input list is</font></i>
    <i><font color=#76a396># {0, 2} and the number m of x points is 3, the `dvec` list will look like this:</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># ⎛⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞   ⎛df ⎞  ⎞</font></i>
    <i><font color=#76a396># ⎜⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟   ⎜───⎟  ⎟</font></i>
    <i><font color=#76a396># ⎜⎝dp0⎠   ⎝dp0⎠   ⎝dp0⎠   ⎝dp2⎠   ⎝dp2⎠   ⎝dp2⎠  ⎟</font></i>
    <i><font color=#76a396># ⎝     x0      x1      x2      x0      x1      x2⎠</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396>#</font></i>
    <i><font color=#76a396># Description of keys and data in returned dictionary:</font></i>
    <i><font color=#76a396>#   -bestnorm - final chi^2</font></i>
    <i><font color=#76a396>#   -orignorm - starting value of chi^2</font></i>
    <i><font color=#76a396>#   -status - fitting status code</font></i>
    <i><font color=#76a396>#   -niter - number of iterations</font></i>
    <i><font color=#76a396>#   -nfev - number of function evaluations</font></i>
    <i><font color=#76a396>#   -npar - total number of parameters</font></i>
    <i><font color=#76a396>#   -nfree - number of free parameters</font></i>
    <i><font color=#76a396>#   -npegged - number of pegged parameters</font></i>
    <i><font color=#76a396>#   -nfunc - number of residuals (= num. of data points)</font></i>
    <i><font color=#76a396>#   -resid - list of final residuals</font></i>
    <i><font color=#76a396>#   -xerror - final parameter uncertainties (1-sigma),</font></i>
    <i><font color=#76a396>#   -x - final parameters values list</font></i>
    <i><font color=#76a396>#   -debug - string with derivatives debugging output</font></i>
    <i><font color=#76a396>#   -covar - final parameters covariance matrix.</font></i>
    <i><font color=#76a396>#</font></i>
    <i><font color=#76a396># Synopsis: -funct value -m value -xall list -pdata value ?-pars list? ?-ftol value? ?-xtol value?</font></i>
    <i><font color=#76a396>#   ?-gtol value? ?-stepfactor value? ?-covtol value? ?-maxiter value? ?-maxfev value? ?-epsfcn value?</font></i>
    <i><font color=#76a396>#   ?-nofinitecheck?</font></i>
    argparse {
        {<font color=#b9b96e>-funct</font>= <font color=#b9b96e>-required</font>}
        {<font color=#b9b96e>-m</font>= <font color=#b9b96e>-required</font> <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is integer <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-xall</font>= <font color=#b9b96e>-required</font>}
        {<font color=#b9b96e>-pars</font>= <font color=#b9b96e>-required</font>}
        {<font color=#b9b96e>-pdata</font>= <font color=#b9b96e>-default</font> <font color=#90ee90>&quot;&quot;</font>}
        {<font color=#b9b96e>-ftol</font>= <font color=#b9b96e>-default</font> 1e-10 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-xtol</font>= <font color=#b9b96e>-default</font> 1e-10 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-gtol</font>= <font color=#b9b96e>-default</font> 1e-10 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-stepfactor</font>= <font color=#b9b96e>-default</font> 100 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-covtol</font>= <font color=#b9b96e>-default</font> 1e-14 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-maxiter</font>= <font color=#b9b96e>-default</font> 200 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is integer <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-maxfev</font>= <font color=#b9b96e>-default</font> 0 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is integer <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-epsfcn</font>= <font color=#b9b96e>-default</font> 2.2204460e-16 <font color=#b9b96e>-validate</font> {[<b><font color=#ffa500>string</font></b> is double <font color=#f1b479>$arg</font>]}}
        {<font color=#b9b96e>-nofinitecheck</font> <font color=#b9b96e>-boolean</font>}
    }
    <b><font color=#ffa500>set</font></b> one 1.0
    <b><font color=#ffa500>set</font></b> p1 0.1
    <b><font color=#ffa500>set</font></b> p5 0.5
    <b><font color=#ffa500>set</font></b> p25 0.25
    <b><font color=#ffa500>set</font></b> p75 0.75
    <b><font color=#ffa500>set</font></b> p0001 1e-4
    <b><font color=#ffa500>set</font></b> zero 0.0
    <b><font color=#ffa500>set</font></b> npar [<b><font color=#ffa500>llength</font></b> <font color=#f1b479>$xall</font>]
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$funct</font>==&quot;&quot;} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_FUNC</font> <font color=#90ee90>&quot;Name of function must not be empty string&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$m</font>&lt;=0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_NPOINTS</font> <font color=#90ee90>&quot;m must be more than 0&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$xall</font>==&quot;&quot;} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_NPOINTS</font> <font color=#90ee90>&quot;xall can't be empty string&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$pars</font>!=&quot;&quot;} {
        <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>llength</font></b> <font color=#f1b479>$xall</font>]!=[<b><font color=#ffa500>llength</font></b> <font color=#f1b479>$pars</font>]} {
            <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_NPARDEF</font> <font color=#90ee90>&quot;xall length '<font color=#f1b479>[</font>llength <font color=#f1b479>$</font>xall<font color=#f1b479>]</font>' is not equal to length of pars '<font color=#f1b479>[</font>llength <font color=#f1b479>$</font>pars<font color=#f1b479>]</font>'&quot;</font>
        }
    }

    <b><font color=#ffa500>set</font></b> iflag 0
    <b><font color=#ffa500>set</font></b> qanylim 0
    <b><font color=#ffa500>set</font></b> npegged 0
    <b><font color=#ffa500>set</font></b> nfev 0
    <b><font color=#ffa500>set</font></b> info 0
    <b><font color=#ffa500>set</font></b> fnorm -1.0
    <b><font color=#ffa500>set</font></b> fnorm1 -1.0
    <b><font color=#ffa500>set</font></b> xnorm -1.0
    <b><font color=#ffa500>set</font></b> delta 0.0
    <b><font color=#ffa500>set</font></b> par 0.0

    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$pars</font>!=&quot;&quot;} {
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>set</font></b> par [@ <font color=#f1b479>$pars</font> <font color=#f1b479>$i</font>]
            <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> fixed]} {
                <b><font color=#ffa500>lappend</font></b> pfixed 1
            } <b><font color=#ffa500>else</font></b> {
                <b><font color=#ffa500>lappend</font></b> pfixed 0
            }
            <b><font color=#ffa500>lappend</font></b> step [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> step]
            <b><font color=#ffa500>lappend</font></b> dstep [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> relstep]
            <b><font color=#ffa500>lappend</font></b> mpside [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> side]
            <b><font color=#ffa500>lappend</font></b> ddebug [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> deriv_debug]
            <b><font color=#ffa500>lappend</font></b> ddrtol [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> deriv_reltol]
            <b><font color=#ffa500>lappend</font></b> ddatol [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> deriv_abstol]
        }
    } <b><font color=#ffa500>else</font></b> {
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lappend</font></b> pfixed 0
        }
        <b><font color=#ffa500>set</font></b> step <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> dstep <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> mpside <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> ddebug <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> ddrtol <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> ddatol <font color=#90ee90>&quot;&quot;</font>
    }
    <i><font color=#76a396># Finish up the free parameters</font></i>
    <b><font color=#ffa500>set</font></b> nfree 0
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lappend</font></b> ifree 0
    }
    <b><font color=#ffa500>set</font></b> j 0
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$pfixed</font> <font color=#f1b479>$i</font>]==0} {
            <b><font color=#ffa500>incr</font></b> nfree
            <b><font color=#ffa500>lset</font></b> ifree <font color=#f1b479>$j</font> <font color=#f1b479>$i</font>
            <b><font color=#ffa500>incr</font></b> j
        }
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$nfree</font>==0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_NFREE</font> <font color=#90ee90>&quot;All parameters are fixed, optimization is not possible&quot;</font>
    }

    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$pars</font>!=&quot;&quot;} {
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>set</font></b> par [@ <font color=#f1b479>$pars</font> <font color=#f1b479>$i</font>]
            <b><font color=#ffa500>if</font></b> {([<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> fixed]==0) && [@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limited] 0] && [@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limited] 1] && ([@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limits] 0] &gt;= [@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limits] 1])} {
                <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_BOUNDS</font> <font color=#90ee90>&quot;Lower limit of parameter cannot be higher than upper limit&quot;</font>
            }
            <b><font color=#ffa500>if</font></b> {([@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limited] 0] && ([@ <font color=#f1b479>$xall</font> <font color=#f1b479>$i</font>] &lt; [@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limits] 0])) || ([@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limited] 1] && ([@ <font color=#f1b479>$xall</font> <font color=#f1b479>$i</font>] &gt; [@ [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$par</font> limits] 1]))} {
                <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_INITBOUNDS</font> <font color=#90ee90>&quot;Initial parameters values are outside the boundaries&quot;</font>
            }
        }
        <i><font color=#76a396># allocate lists with zeros</font></i>
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lappend</font></b> qllim 0
            <b><font color=#ffa500>lappend</font></b> qulim 0
            <b><font color=#ffa500>lappend</font></b> llim 0
            <b><font color=#ffa500>lappend</font></b> ulim 0
        }
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lset</font></b> qllim <font color=#f1b479>$i</font> [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>]] limited] 0]
            <b><font color=#ffa500>lset</font></b> qulim <font color=#f1b479>$i</font> [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>]] limited] 1]
            <b><font color=#ffa500>lset</font></b> llim <font color=#f1b479>$i</font> [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>]] limits] 0]
            <b><font color=#ffa500>lset</font></b> ulim <font color=#f1b479>$i</font> [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>]] limits] 1]
            <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$qllim</font> <font color=#f1b479>$i</font>] || [@ <font color=#f1b479>$qulim</font> <font color=#f1b479>$i</font>]} {
                <b><font color=#ffa500>set</font></b> qanylim 1
            }
        }
    } <b><font color=#ffa500>else</font></b> {
        <b><font color=#ffa500>set</font></b> qllim <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> qulim <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> llim <font color=#90ee90>&quot;&quot;</font>
        <b><font color=#ffa500>set</font></b> ulim <font color=#90ee90>&quot;&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$ftol</font>&lt;=0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_PARAM</font> <font color=#90ee90>&quot;ftol value '<font color=#f1b479>$</font>ftol' must be higher than 0&quot;</font>
    } <b><font color=#ffa500>elseif</font></b> {<font color=#f1b479>$xtol</font>&lt;=0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_PARAM</font> <font color=#90ee90>&quot;xtol value '<font color=#f1b479>$</font>xtol' must be higher than 0&quot;</font>
    } <b><font color=#ffa500>elseif</font></b> {<font color=#f1b479>$gtol</font>&lt;=0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_PARAM</font> <font color=#90ee90>&quot;gtol value '<font color=#f1b479>$</font>gtol' must be higher than 0&quot;</font>
    } <b><font color=#ffa500>elseif</font></b> {<font color=#f1b479>$maxiter</font>&lt;0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_PARAM</font> <font color=#90ee90>&quot;maxiter value '<font color=#f1b479>$</font>maxiter' must be higher than or equal to 0&quot;</font>
    } <b><font color=#ffa500>elseif</font></b> {<font color=#f1b479>$stepfactor</font>&lt;=0} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_PARAM</font> <font color=#90ee90>&quot;stepfactor value '<font color=#f1b479>$</font>stepfactor' must be higher than 0&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$m</font> &lt; <font color=#f1b479>$nfree</font>} {
        <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_DOF</font> <font color=#90ee90>&quot;Degree of freedom check failed because of 'm=<font color=#f1b479>$</font>m&gt;=n=<font color=#f1b479>$</font>nfree'&quot;</font>
    }

    <i><font color=#76a396># allocate temporary storage</font></i>
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lappend</font></b> diag 0
    }
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lappend</font></b> wa4 0
    }
    <b><font color=#ffa500>set</font></b> ldfjac <font color=#f1b479>$m</font>

    <i><font color=#76a396># Evaluate user function with initial parameter values</font></i>
    <b><font color=#ffa500>set</font></b> fvec [<b><font color=#ffa500>dget</font></b> [<font color=#f1b479>$funct</font> <font color=#f1b479>$xall</font> <font color=#f1b479>$pdata</font>] fvec]
    <b><font color=#ffa500>incr</font></b> nfev
    <b><font color=#ffa500>set</font></b> fnorm [::tclopt::enorm <font color=#f1b479>$fvec</font>]
    <i><font color=#76a396>#puts $fnorm</font></i>
    <b><font color=#ffa500>set</font></b> orignorm [= {<font color=#f1b479>$fnorm</font>*<font color=#f1b479>$fnorm</font>}]

    <i><font color=#76a396># Make a new copy</font></i>
    <b><font color=#ffa500>set</font></b> xnew <font color=#f1b479>$xall</font>
    <i><font color=#76a396># Transfer free parameters to 'x'</font></i>
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lappend</font></b> x [@ <font color=#f1b479>$xall</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>]]
    }
    <i><font color=#76a396># Initialize Levelberg-Marquardt parameter and iteration counter</font></i>
    <b><font color=#ffa500>set</font></b> par 0.0
    <b><font color=#ffa500>set</font></b> iter 1
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lappend</font></b> qtf 0
    }

    <i><font color=#76a396># Beginning of the outer loop</font></i>
    <b><font color=#ffa500>while</font></b> {true} {
        <i><font color=#76a396># puts &quot;beginning of the outer loop&quot;</font></i>
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lset</font></b> xnew [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>] [@ <font color=#f1b479>$x</font> <font color=#f1b479>$i</font>]
        }
        <i><font color=#76a396># Calculate the jacobian matrix</font></i>
        <b><font color=#ffa500>set</font></b> fdjac2Data [::tclopt::fdjac2 <font color=#f1b479>$funct</font> <font color=#f1b479>$m</font> <font color=#f1b479>$ifree</font> <font color=#f1b479>$nfree</font> <font color=#f1b479>$xnew</font> <font color=#f1b479>$fvec</font> <font color=#f1b479>$ldfjac</font> <font color=#f1b479>$epsfcn</font> <font color=#f1b479>$pdata</font> <font color=#f1b479>$nfev</font> <font color=#f1b479>$step</font> <font color=#f1b479>$dstep</font> <font color=#f1b479>$mpside</font> <font color=#f1b479>$qulim</font> <font color=#f1b479>$ulim</font> <font color=#f1b479>$ddebug</font> <font color=#f1b479>$ddrtol</font> <font color=#f1b479>$ddatol</font>]
        <b><font color=#ffa500>set</font></b> fjac [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$fdjac2Data</font> fjac]
        <b><font color=#ffa500>set</font></b> nfev [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$fdjac2Data</font> nfev]
        <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>dexist</font></b> <font color=#f1b479>$fdjac2Data</font> debug]} {
            <b><font color=#ffa500>lappend</font></b> debugOutput {<b><font color=#ffa500>*</font></b>}[<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$fdjac2Data</font> debug]
        }
        <i><font color=#76a396># Determine if any of the parameters are pegged at the limits</font></i>
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$qanylim</font>} {
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>set</font></b> lpegged [= {[@ <font color=#f1b479>$qllim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]==[@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>])}]
                <b><font color=#ffa500>set</font></b> upegged [= {[@ <font color=#f1b479>$qulim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]==[@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>])}]
                <b><font color=#ffa500>set</font></b> sum 0
                <i><font color=#76a396># If the parameter is pegged at a limit, compute the gradient direction</font></i>
                <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$lpegged</font> || <font color=#f1b479>$upegged</font>} {
                    <b><font color=#ffa500>set</font></b> ij [= {<font color=#f1b479>$j</font>*<font color=#f1b479>$ldfjac</font>}]
                    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                        <b><font color=#ffa500>set</font></b> sum [= {<font color=#f1b479>$sum</font>+[@ <font color=#f1b479>$fvec</font> <font color=#f1b479>$i</font>]*[@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$ij</font>]}]
                        <b><font color=#ffa500>incr</font></b> ij
                    }
                }
                <i><font color=#76a396># If pegged at lower limit and gradient is toward negative then reset gradient to zero</font></i>
                <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$lpegged</font> && (<font color=#f1b479>$sum</font>&gt;0)} {
                    <b><font color=#ffa500>set</font></b> ij [= {<font color=#f1b479>$j</font>*<font color=#f1b479>$ldfjac</font>}]
                    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                        <b><font color=#ffa500>lset</font></b> fjac <font color=#f1b479>$ij</font> 0
                        <b><font color=#ffa500>incr</font></b> ij
                    }
                }
                <i><font color=#76a396># If pegged at upper limit and gradient is toward positive then reset gradient to zero</font></i>
                <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$upegged</font> && (<font color=#f1b479>$sum</font>&lt;0)} {
                    <b><font color=#ffa500>set</font></b> ij [= {<font color=#f1b479>$j</font>*<font color=#f1b479>$ldfjac</font>}]
                    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                        <b><font color=#ffa500>lset</font></b> fjac <font color=#f1b479>$ij</font> 0
                        <b><font color=#ffa500>incr</font></b> ij
                    }
                }
            }
        }
        <i><font color=#76a396># Compute the QR factorization of the jacobian</font></i>
        <b><font color=#ffa500>set</font></b> qfracData [::tclopt::qfrac <font color=#f1b479>$m</font> <font color=#f1b479>$nfree</font> <font color=#f1b479>$fjac</font> <font color=#f1b479>$ldfjac</font> 1 <font color=#f1b479>$nfree</font>]
        <b><font color=#ffa500>set</font></b> ipvt [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$qfracData</font> ipvt]
        <b><font color=#ffa500>set</font></b> fjac [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$qfracData</font> a]
        <b><font color=#ffa500>set</font></b> wa1 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$qfracData</font> rdiag]
        <b><font color=#ffa500>set</font></b> wa2 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$qfracData</font> acnorm]
        <b><font color=#ffa500>set</font></b> wa3 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$qfracData</font> wa]

        <i><font color=#76a396># on the first iteration and if mode is 1, scale according to the norms of the columns of the initial jacobian.</font></i>
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$iter</font>==1} {
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>lset</font></b> diag [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>] [@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]
                <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]==<font color=#f1b479>$zero</font>} {
                    <b><font color=#ffa500>lset</font></b> diag [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>] <font color=#f1b479>$one</font>
                }
            }
            <i><font color=#76a396># on the first iteration, calculate the norm of the scaled x and initialize the step bound delta.</font></i>
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>lset</font></b> wa3 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$diag</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>]]*[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]}]
            }
            <b><font color=#ffa500>set</font></b> xnorm [::tclopt::enorm <font color=#f1b479>$wa3</font>]
            <b><font color=#ffa500>set</font></b> delta [= {<font color=#f1b479>$stepfactor</font>*<font color=#f1b479>$xnorm</font>}]
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$delta</font>==<font color=#f1b479>$zero</font>} {
                <b><font color=#ffa500>set</font></b> delta <font color=#f1b479>$stepfactor</font>
            }
        }

        <i><font color=#76a396># form (q transpose)*fvec and store the first n components in qtf</font></i>
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lset</font></b> wa4 <font color=#f1b479>$i</font> [@ <font color=#f1b479>$fvec</font> <font color=#f1b479>$i</font>]
        }
        <b><font color=#ffa500>set</font></b> jj 0
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
            <b><font color=#ffa500>set</font></b> temp3 [@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$jj</font>]
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$temp3</font>!=<font color=#f1b479>$zero</font>} {
                <b><font color=#ffa500>set</font></b> sum <font color=#f1b479>$zero</font>
                <b><font color=#ffa500>set</font></b> ij <font color=#f1b479>$jj</font>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i <font color=#f1b479>$j</font>} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                    <b><font color=#ffa500>set</font></b> sum [= {<font color=#f1b479>$sum</font>+[@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$ij</font>]*[@ <font color=#f1b479>$wa4</font> <font color=#f1b479>$i</font>]}]
                    <b><font color=#ffa500>incr</font></b> ij;<i><font color=#76a396> # fjac[i+m*j]</font></i>
                }
                <b><font color=#ffa500>set</font></b> temp [= {-<font color=#f1b479>$sum</font>/<font color=#f1b479>$temp3</font>}]
                <b><font color=#ffa500>set</font></b> ij <font color=#f1b479>$jj</font>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i <font color=#f1b479>$j</font>} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                    <b><font color=#ffa500>lset</font></b> wa4 <font color=#f1b479>$i</font> [= {[@ <font color=#f1b479>$wa4</font> <font color=#f1b479>$i</font>]+[@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$ij</font>]*<font color=#f1b479>$temp</font>}]
                    <b><font color=#ffa500>incr</font></b> ij;<i><font color=#76a396> # fjac[i+m*j]</font></i>
                }
            }
            <b><font color=#ffa500>lset</font></b> fjac <font color=#f1b479>$jj</font> [@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]
            <b><font color=#ffa500>incr</font></b> jj [= {<font color=#f1b479>$m</font>+1}];<i><font color=#76a396> # fjac[j+m*j]&quot;</font></i>
            <b><font color=#ffa500>lset</font></b> qtf <font color=#f1b479>$j</font> [@ <font color=#f1b479>$wa4</font> <font color=#f1b479>$j</font>]
        }

        <i><font color=#76a396># (From this point on, only the square matrix, consisting of the triangle of R, is needed.)</font></i>
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$nofinitecheck</font>} {
            <i><font color=#76a396># Check for overflow.  This should be a cheap test here since FJAC</font></i>
            <i><font color=#76a396># has been reduced to a (small) square matrix, and the test is O(N^2).</font></i>
            <b><font color=#ffa500>set</font></b> off 0
            <b><font color=#ffa500>set</font></b> nonfinite 0
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
                    <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$fjac</font> [= {<font color=#f1b479>$off</font>+<font color=#f1b479>$i</font>}]]&gt;<font color=#f1b479>$::tclopt::MP_GIANT</font>} {
                        <b><font color=#ffa500>set</font></b> nonfinite 1
                    }
                }
                <b><font color=#ffa500>incr</font></b> off <font color=#f1b479>$ldfjac</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$nonfinite</font>} {
                <b><font color=#fe6efe>return</font></b> <font color=#b9b96e>-code</font> error <font color=#b9b96e>-errorcode</font> <font color=#f1b479>$::tclopt::MP_ERR_NAN</font> <font color=#90ee90>&quot;Overflow occured during finite check&quot;</font>
            }
        }

        <i><font color=#76a396># compute the norm of the scaled gradient.</font></i>
        <b><font color=#ffa500>set</font></b> gnorm <font color=#f1b479>$zero</font>
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$fnorm</font>!=<font color=#f1b479>$zero</font>} {
            <b><font color=#ffa500>set</font></b> jj 0
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>set</font></b> l [@ <font color=#f1b479>$ipvt</font> <font color=#f1b479>$j</font>]
                <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$l</font>]!=<font color=#f1b479>$zero</font>} {
                    <b><font color=#ffa500>set</font></b> sum <font color=#f1b479>$zero</font>
                    <b><font color=#ffa500>set</font></b> ij <font color=#f1b479>$jj</font>
                    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;=<font color=#f1b479>$j</font>} {<b><font color=#ffa500>incr</font></b> i} {
                        <b><font color=#ffa500>set</font></b> sum [= {<font color=#f1b479>$sum</font>+[@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$ij</font>]*[@ <font color=#f1b479>$qtf</font> <font color=#f1b479>$i</font>]/<font color=#f1b479>$fnorm</font>}]
                        <b><font color=#ffa500>incr</font></b> ij;<i><font color=#76a396> # fjac[i+m*j]</font></i>
                    }
                    <b><font color=#ffa500>set</font></b> gnorm [::tclopt::dmax1 <font color=#f1b479>$gnorm</font> [= {abs(<font color=#f1b479>$sum</font>/[@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$l</font>])}]]
                }
                <b><font color=#ffa500>incr</font></b> jj <font color=#f1b479>$m</font>
            }
        }

        <i><font color=#76a396># test for convergence of the gradient norm.</font></i>
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$gnorm</font>&lt;=<font color=#f1b479>$gtol</font>} {
            <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_OK_DIR</font>
        }
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$info</font>!=0} {
            <b><font color=#fe6efe>break</font></b>
        }
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$maxiter</font>==0} {
            <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_MAXITER</font>
            <b><font color=#fe6efe>break</font></b>
        }

        <i><font color=#76a396># rescale</font></i>
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
            <b><font color=#ffa500>lset</font></b> diag [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>] [::tclopt::dmax1 [@ <font color=#f1b479>$diag</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>]] [@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]]
        }

        <i><font color=#76a396># beginning of the inner loop.</font></i>
        <b><font color=#ffa500>while</font></b> {true} {
            <i><font color=#76a396># determine the levenberg-marquardt parameter.</font></i>
            <b><font color=#ffa500>set</font></b> lmparData [::tclopt::lmpar <font color=#f1b479>$nfree</font> <font color=#f1b479>$fjac</font> <font color=#f1b479>$ldfjac</font> <font color=#f1b479>$ipvt</font> <font color=#f1b479>$ifree</font> <font color=#f1b479>$diag</font> <font color=#f1b479>$qtf</font> <font color=#f1b479>$delta</font> <font color=#f1b479>$par</font>]
            <b><font color=#ffa500>set</font></b> fjac [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$lmparData</font> r]
            <b><font color=#ffa500>set</font></b> par [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$lmparData</font> par]
            <b><font color=#ffa500>set</font></b> wa1 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$lmparData</font> x]
            <b><font color=#ffa500>set</font></b> wa2 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$lmparData</font> sdiag]
            <b><font color=#ffa500>set</font></b> wa3 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$lmparData</font> wa1]
            <i><font color=#76a396># store the direction p and x + p. calculate the norm of p.</font></i>
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>lset</font></b> wa1 <font color=#f1b479>$j</font> [= {-[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]
            }
            <b><font color=#ffa500>set</font></b> alpha 1.0
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$qanylim</font>==0} {
                <i><font color=#76a396># No parameter limits, so just move to new position WA2</font></i>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                    <b><font color=#ffa500>lset</font></b> wa2 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]+[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]
                }
            } <b><font color=#ffa500>else</font></b> {
                <i><font color=#76a396># Respect the limits.  If a step were to go out of bounds, then</font></i>
                <i><font color=#76a396># we should take a step in the same direction but shorter distance.</font></i>
                <i><font color=#76a396># The step should take us right to the limit in that case.</font></i>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                    <b><font color=#ffa500>set</font></b> lpegged [= {[@ <font color=#f1b479>$qllim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]&lt;=[@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>])}]
                    <b><font color=#ffa500>set</font></b> upegged [= {[@ <font color=#f1b479>$qulim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]&gt;=[@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>])}]
                    <b><font color=#ffa500>set</font></b> dwa1 [= {abs([@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>])&gt;<font color=#f1b479>$::tclopt::MP_MACHEP0</font>}]

                    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$lpegged</font> && ([@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]&lt;0)} {
                        <b><font color=#ffa500>lset</font></b> wa1 <font color=#f1b479>$j</font> 0
                    }
                    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$upegged</font> && ([@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]&gt;0)} {
                        <b><font color=#ffa500>lset</font></b> wa1 <font color=#f1b479>$j</font> 0
                    }
                    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$dwa1</font> && [@ <font color=#f1b479>$qllim</font> <font color=#f1b479>$j</font>] && ([= {[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]+[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]&lt;[@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>])} {
                        <b><font color=#ffa500>set</font></b> alpha [::tclopt::dmin1 <font color=#f1b479>$alpha</font> [= {([@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>]-[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>])/[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]]
                    }
                    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$dwa1</font> && [@ <font color=#f1b479>$qulim</font> <font color=#f1b479>$j</font>] && ([= {[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]+[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]&gt;[@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>])} {
                        <b><font color=#ffa500>set</font></b> alpha [::tclopt::dmin1 <font color=#f1b479>$alpha</font> [= {([@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>]-[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>])/[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]]
                    }
                }

                <i><font color=#76a396># Scale the resulting vector, advance to the next position</font></i>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                    <b><font color=#ffa500>lset</font></b> wa1 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]*<font color=#f1b479>$alpha</font>}]
                    <b><font color=#ffa500>lset</font></b> wa2 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]+[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]
                    <i><font color=#76a396># Adjust the output values.  If the step put us exactly on a boundary, make sure it is exact.</font></i>
                    <b><font color=#ffa500>set</font></b> sgnu [= {([@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>]&gt;=0) ? 1 : -1}]
                    <b><font color=#ffa500>set</font></b> sgnl [= {([@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>]&gt;=0) ? 1 : -1}]
                    <b><font color=#ffa500>set</font></b> ulim1 [= {[@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>]*(1-<font color=#f1b479>$sgnu</font>*<font color=#f1b479>$::tclopt::MP_MACHEP0</font>)- (([@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>]==0) ? <font color=#f1b479>$::tclopt::MP_MACHEP0</font> : 0)}]
                    <b><font color=#ffa500>set</font></b> llim1 [= {[@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>]*(1+<font color=#f1b479>$sgnl</font>*<font color=#f1b479>$::tclopt::MP_MACHEP0</font>)+ (([@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>]==0) ? <font color=#f1b479>$::tclopt::MP_MACHEP0</font> : 0)}]
                    <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$qulim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]&gt;=<font color=#f1b479>$ulim1</font>)} {
                        <b><font color=#ffa500>lset</font></b> wa2 <font color=#f1b479>$j</font> [@ <font color=#f1b479>$ulim</font> <font color=#f1b479>$j</font>]
                    }
                    <b><font color=#ffa500>if</font></b> {[@ <font color=#f1b479>$qllim</font> <font color=#f1b479>$j</font>] && ([@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]&lt;=<font color=#f1b479>$llim1</font>)} {
                        <b><font color=#ffa500>lset</font></b> wa2 <font color=#f1b479>$j</font> [@ <font color=#f1b479>$llim</font> <font color=#f1b479>$j</font>]
                    }
                }
            }
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>lset</font></b> wa3 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$diag</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>]]*[@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$j</font>]}]
            }
            <b><font color=#ffa500>set</font></b> pnorm [::tclopt::enorm <font color=#f1b479>$wa3</font>]

            <i><font color=#76a396># on the first iteration, adjust the initial step bound.</font></i>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$iter</font>==1} {
                <b><font color=#ffa500>set</font></b> delta [::tclopt::dmin1 <font color=#f1b479>$delta</font> <font color=#f1b479>$pnorm</font>]
            }

            <i><font color=#76a396># evaluate the function at x + p and calculate its norm.</font></i>
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
                <b><font color=#ffa500>lset</font></b> xnew [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>] [@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$i</font>]
            }
            <b><font color=#ffa500>set</font></b> functData [<font color=#f1b479>$funct</font> <font color=#f1b479>$xnew</font> <font color=#f1b479>$pdata</font>]
            <b><font color=#ffa500>set</font></b> wa4 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$functData</font> fvec]
            <b><font color=#ffa500>incr</font></b> nfev
            <b><font color=#ffa500>set</font></b> fnorm1 [::tclopt::enorm <font color=#f1b479>$wa4</font>]

            <i><font color=#76a396># compute the scaled actual reduction.</font></i>
            <b><font color=#ffa500>set</font></b> actred [= {-<font color=#f1b479>$one</font>}]
            <b><font color=#ffa500>if</font></b> {[= {<font color=#f1b479>$p1</font>*<font color=#f1b479>$fnorm1</font>}]&lt;<font color=#f1b479>$fnorm</font>} {
                <b><font color=#ffa500>set</font></b> temp [= {<font color=#f1b479>$fnorm1</font>/<font color=#f1b479>$fnorm</font>}]
                <b><font color=#ffa500>set</font></b> actred [= {<font color=#f1b479>$one</font>-<font color=#f1b479>$temp</font>*<font color=#f1b479>$temp</font>}]
            }

            <i><font color=#76a396># compute the scaled predicted reduction and the scaled directional derivative.</font></i>
            <b><font color=#ffa500>set</font></b> jj 0
            <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                <b><font color=#ffa500>lset</font></b> wa3 <font color=#f1b479>$j</font> <font color=#f1b479>$zero</font>
                <b><font color=#ffa500>set</font></b> l [@ <font color=#f1b479>$ipvt</font> <font color=#f1b479>$j</font>]
                <b><font color=#ffa500>set</font></b> temp [@ <font color=#f1b479>$wa1</font> <font color=#f1b479>$l</font>]
                <b><font color=#ffa500>set</font></b> ij <font color=#f1b479>$jj</font>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;=<font color=#f1b479>$j</font>} {<b><font color=#ffa500>incr</font></b> i} {
                    <b><font color=#ffa500>lset</font></b> wa3 <font color=#f1b479>$i</font> [= {[@ <font color=#f1b479>$wa3</font> <font color=#f1b479>$i</font>]+[@ <font color=#f1b479>$fjac</font> <font color=#f1b479>$ij</font>]*<font color=#f1b479>$temp</font>}]
                    <b><font color=#ffa500>incr</font></b> ij
                }
                <b><font color=#ffa500>incr</font></b> jj <font color=#f1b479>$m</font>
            }

            <i><font color=#76a396># Remember, alpha is the fraction of the full LM step actually taken</font></i>
            <b><font color=#ffa500>set</font></b> temp1 [= {[::tclopt::enorm <font color=#f1b479>$wa3</font>]*<font color=#f1b479>$alpha</font>/<font color=#f1b479>$fnorm</font>}]
            <b><font color=#ffa500>set</font></b> temp2 [= {sqrt(<font color=#f1b479>$par</font>*<font color=#f1b479>$alpha</font>)*<font color=#f1b479>$pnorm</font>/<font color=#f1b479>$fnorm</font>}]
            <b><font color=#ffa500>set</font></b> prered [= {<font color=#f1b479>$temp1</font>*<font color=#f1b479>$temp1</font>+(<font color=#f1b479>$temp2</font>*<font color=#f1b479>$temp2</font>)/<font color=#f1b479>$p5</font>}]
            <b><font color=#ffa500>set</font></b> dirder [= {-(<font color=#f1b479>$temp1</font>*<font color=#f1b479>$temp1</font>+<font color=#f1b479>$temp2</font>*<font color=#f1b479>$temp2</font>)}]

            <i><font color=#76a396># compute the ratio of the actual to the predicted reduction</font></i>
            <b><font color=#ffa500>set</font></b> ratio <font color=#f1b479>$zero</font>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$prered</font>!=<font color=#f1b479>$zero</font>} {
                <b><font color=#ffa500>set</font></b> ratio [= {<font color=#f1b479>$actred</font>/<font color=#f1b479>$prered</font>}]
            }

            <i><font color=#76a396># update the step bound.</font></i>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$ratio</font>&lt;=<font color=#f1b479>$p25</font>} {
                <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$actred</font>&gt;=<font color=#f1b479>$zero</font>} {
                    <b><font color=#ffa500>set</font></b> temp <font color=#f1b479>$p5</font>
                } <b><font color=#ffa500>else</font></b> {
                    <b><font color=#ffa500>set</font></b> temp [= {<font color=#f1b479>$p5</font>*<font color=#f1b479>$dirder</font>/(<font color=#f1b479>$dirder</font>+<font color=#f1b479>$p5</font>*<font color=#f1b479>$actred</font>)}]
                }
                <b><font color=#ffa500>if</font></b> {([= {<font color=#f1b479>$p1</font>*<font color=#f1b479>$fnorm1</font>}]&gt;=<font color=#f1b479>$fnorm</font>) || (<font color=#f1b479>$temp</font>&lt;<font color=#f1b479>$p1</font>)} {
                    <b><font color=#ffa500>set</font></b> temp <font color=#f1b479>$p1</font>
                }
                <b><font color=#ffa500>set</font></b> delta [= {<font color=#f1b479>$temp</font>*[::tclopt::dmin1 <font color=#f1b479>$delta</font> [= {<font color=#f1b479>$pnorm</font>/<font color=#f1b479>$p1</font>}]]}]
                <b><font color=#ffa500>set</font></b> par [= {<font color=#f1b479>$par</font>/<font color=#f1b479>$temp</font>}]
            } <b><font color=#ffa500>else</font></b> {
                <b><font color=#ffa500>if</font></b> {(<font color=#f1b479>$par</font>==<font color=#f1b479>$zero</font>) || (<font color=#f1b479>$ratio</font>&gt;=<font color=#f1b479>$p75</font>)} {
                    <b><font color=#ffa500>set</font></b> delta [= {<font color=#f1b479>$pnorm</font>/<font color=#f1b479>$p5</font>}]
                    <b><font color=#ffa500>set</font></b> par [= {<font color=#f1b479>$p5</font>*<font color=#f1b479>$par</font>}]
                }
            }

            <i><font color=#76a396># test for successful iteration.</font></i>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$ratio</font>&gt;=<font color=#f1b479>$p0001</font>} {
                <i><font color=#76a396># successful iteration. update x, fvec, and their norms.</font></i>
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
                    <b><font color=#ffa500>lset</font></b> x <font color=#f1b479>$j</font> [@ <font color=#f1b479>$wa2</font> <font color=#f1b479>$j</font>]
                    <i><font color=#76a396>#puts $x</font></i>
                    <b><font color=#ffa500>lset</font></b> wa2 <font color=#f1b479>$j</font> [= {[@ <font color=#f1b479>$diag</font> [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>]]*[@ <font color=#f1b479>$x</font> <font color=#f1b479>$j</font>]}]
                }
                <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> i} {
                    <b><font color=#ffa500>lset</font></b> fvec <font color=#f1b479>$i</font> [@ <font color=#f1b479>$wa4</font> <font color=#f1b479>$i</font>]
                }
                <b><font color=#ffa500>set</font></b> xnorm [::tclopt::enorm <font color=#f1b479>$wa2</font>]
                <b><font color=#ffa500>set</font></b> fnorm <font color=#f1b479>$fnorm1</font>
                <b><font color=#ffa500>incr</font></b> iter
            }

            <i><font color=#76a396># tests for convergence.</font></i>
            <b><font color=#ffa500>if</font></b> {(abs(<font color=#f1b479>$actred</font>)&lt;=<font color=#f1b479>$ftol</font>) && (<font color=#f1b479>$prered</font>&lt;=<font color=#f1b479>$ftol</font>) && (<font color=#f1b479>$p5</font>*<font color=#f1b479>$ratio</font>&lt;=<font color=#f1b479>$one</font>)} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_OK_CHI</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$delta</font>&lt;=(<font color=#f1b479>$xtol</font>*<font color=#f1b479>$xnorm</font>)} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_OK_PAR</font>
            }
            <b><font color=#ffa500>if</font></b> {(abs(<font color=#f1b479>$actred</font>)&lt;=<font color=#f1b479>$ftol</font>) && (<font color=#f1b479>$prered</font>&lt;=<font color=#f1b479>$ftol</font>) && (<font color=#f1b479>$p5</font>*<font color=#f1b479>$ratio</font>&lt;=<font color=#f1b479>$one</font>) && (<font color=#f1b479>$info</font>==2)} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_OK_BOTH</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$info</font>!=0} {
                <b><font color=#fe6efe>break</font></b>
            }

            <i><font color=#76a396># tests for termination and stringent tolerances.</font></i>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$maxfev</font>&gt;0 && <font color=#f1b479>$nfev</font>&gt;=<font color=#f1b479>$maxfev</font>} {
                <i><font color=#76a396># Too many function evaluations</font></i>
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_MAXITER</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$iter</font>&gt;=<font color=#f1b479>$maxiter</font>} {
                <i><font color=#76a396># Too many iterations</font></i>
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_MAXITER</font>
            }
            <b><font color=#ffa500>if</font></b> {(abs(<font color=#f1b479>$actred</font>)&lt;=<font color=#f1b479>$::tclopt::MP_MACHEP0</font>) && (<font color=#f1b479>$prered</font>&lt;=<font color=#f1b479>$::tclopt::MP_MACHEP0</font>) && (<font color=#f1b479>$p5</font>*<font color=#f1b479>$ratio</font>&lt;=<font color=#f1b479>$one</font>)} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_FTOL</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$delta</font>&lt;=<font color=#f1b479>$::tclopt::MP_MACHEP0</font>*<font color=#f1b479>$xnorm</font>} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_XTOL</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$gnorm</font>&lt;=<font color=#f1b479>$::tclopt::MP_MACHEP0</font>} {
                <b><font color=#ffa500>set</font></b> info <font color=#f1b479>$::tclopt::MP_GTOL</font>
            }
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$info</font>!=0} {
                <b><font color=#fe6efe>break</font></b>
            }

            <i><font color=#76a396># end of the inner loop. repeat if iteration unsuccessful.</font></i>
            <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$ratio</font>&lt;<font color=#f1b479>$p0001</font>} {
                <b><font color=#fe6efe>continue</font></b>
            } <b><font color=#ffa500>else</font></b> {
                <b><font color=#fe6efe>break</font></b>
            }

        }
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$info</font>!=0} {
            <b><font color=#fe6efe>break</font></b>
        }
    }

    <i><font color=#76a396># termination, either normal or user imposed.</font></i>
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
        <b><font color=#ffa500>lset</font></b> xall [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>] [@ <font color=#f1b479>$x</font> <font color=#f1b479>$i</font>]
    }

    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$info</font>&gt;0} {
        <b><font color=#ffa500>set</font></b> functData [<font color=#f1b479>$funct</font> <font color=#f1b479>$xall</font> <font color=#f1b479>$pdata</font>]
        <b><font color=#ffa500>set</font></b> fvec [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$functData</font> fvec]
        <b><font color=#ffa500>incr</font></b> nfev
    }

    <i><font color=#76a396># Compute number of pegged parameters</font></i>
    <b><font color=#ffa500>set</font></b> npegged 0
    <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$pars</font>!=&quot;&quot;} {
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>set</font></b> parsLim0 [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> <font color=#f1b479>$i</font>] limited] 0]
            <b><font color=#ffa500>set</font></b> parsLim1 [@ [<b><font color=#ffa500>dget</font></b> [@ <font color=#f1b479>$pars</font> <font color=#f1b479>$i</font>] limited] 1]
            <b><font color=#ffa500>if</font></b> {(<font color=#f1b479>$parsLim0</font> && (<font color=#f1b479>$parsLim0</font>==[@ <font color=#f1b479>$xall</font> <font color=#f1b479>$i</font>])) || (<font color=#f1b479>$parsLim1</font> && (<font color=#f1b479>$parsLim1</font>==[@ <font color=#f1b479>$xall</font> <font color=#f1b479>$i</font>]))} {
                <b><font color=#ffa500>incr</font></b> npegged
            }
        }
    }

    <i><font color=#76a396># Compute and return the covariance matrix and/or parameter errors</font></i>
    <b><font color=#ffa500>set</font></b> covarData [::tclopt::covar <font color=#f1b479>$nfree</font> <font color=#f1b479>$fjac</font> <font color=#f1b479>$ldfjac</font> <font color=#f1b479>$ipvt</font> <font color=#f1b479>$covtol</font>]
    <b><font color=#ffa500>set</font></b> fjac [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$covarData</font> r]
    <b><font color=#ffa500>set</font></b> wa2 [<b><font color=#ffa500>dget</font></b> <font color=#f1b479>$covarData</font> wa]
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$npar</font>*<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> j} {
        <b><font color=#ffa500>lappend</font></b> covar 0.0
    }
    <i><font color=#76a396># Transfer the covariance array</font></i>
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
        <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> i 0} {<font color=#f1b479>$i</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> i} {
            <b><font color=#ffa500>lset</font></b> covar [= {int([@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>]*<font color=#f1b479>$npar</font>+[@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$i</font>])}] [@ <font color=#f1b479>$fjac</font> [= {int(<font color=#f1b479>$j</font>*<font color=#f1b479>$ldfjac</font>+<font color=#f1b479>$i</font>)}]]
        }
    }

    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$npar</font>} {<b><font color=#ffa500>incr</font></b> j} {
        <b><font color=#ffa500>lappend</font></b> xerror 0.0
    }
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$nfree</font>} {<b><font color=#ffa500>incr</font></b> j} {
        <b><font color=#ffa500>set</font></b> cc [@ <font color=#f1b479>$fjac</font> [= {int(<font color=#f1b479>$j</font>*<font color=#f1b479>$ldfjac</font>+<font color=#f1b479>$j</font>)}]]
        <b><font color=#ffa500>if</font></b> {<font color=#f1b479>$cc</font>&gt;0} {
            <b><font color=#ffa500>lset</font></b> xerror [@ <font color=#f1b479>$ifree</font> <font color=#f1b479>$j</font>] [= {sqrt(<font color=#f1b479>$cc</font>)}]
        }
    }
    <b><font color=#ffa500>set</font></b> bestnorm [= {[::tclopt::dmax1 <font color=#f1b479>$fnorm</font> <font color=#f1b479>$fnorm1</font>]**2}]
    <b><font color=#ffa500>for</font></b> {<b><font color=#ffa500>set</font></b> j 0} {<font color=#f1b479>$j</font>&lt;<font color=#f1b479>$m</font>} {<b><font color=#ffa500>incr</font></b> j} {
        <b><font color=#ffa500>lappend</font></b> resid [@ <font color=#f1b479>$fvec</font> <font color=#f1b479>$j</font>]
    }
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists debugOutput]} {
        <b><font color=#ffa500>set</font></b> debugOutput [<b><font color=#ffa500>join</font></b> <font color=#f1b479>$debugOutput</font> <font color=#90ee90>&quot;\n&quot;</font>]
    } <b><font color=#ffa500>else</font></b> {
        <b><font color=#ffa500>set</font></b> debugOutput <font color=#90ee90>&quot;&quot;</font>
    }
    <b><font color=#fe6efe>return</font></b> [<b><font color=#ffa500>dcreate</font></b> bestnorm <font color=#f1b479>$bestnorm</font> orignorm <font color=#f1b479>$orignorm</font> status <font color=#f1b479>$info</font> niter <font color=#f1b479>$iter</font> nfev <font color=#f1b479>$nfev</font> npar <font color=#f1b479>$npar</font> nfree <font color=#f1b479>$nfree</font> npegged <font color=#f1b479>$npegged</font> nfunc <font color=#f1b479>$m</font> resid <font color=#f1b479>$resid</font> xerror <font color=#f1b479>$xerror</font> x <font color=#f1b479>$xall</font> debug <font color=#f1b479>$debugOutput</font> covar <font color=#f1b479>$covar</font>]
}</pre></div>
</div><h3 class='ruffproc'><a name='::tclopt::parCreate'>parCreate</a><span class='ns_scope'> [<a href="index-tclopt.html#::tclopt" title="::tclopt" class='ruff_cmd'>::tclopt</a>]</span><span class='ruff-uplink'><a href='#top'>Top</a>, <a href='index.html'>Main</a>, <a href='index-docindex.html#'>Index</a></span></h3>
<div style='clear:both;'></div>
<p class='ruff'>Creates input dictionary for <a href="index-tclopt.html#::tclopt::mpfit" title="mpfit" class='ruff_cmd'>mpfit</a> procedure.</p>
<div class='ruff_synopsis'><span class='ruff_cmd'>parCreate</span> <span class='ruff_arg'>?-fixed? ?-lowlim value? ?-uplim value? ?-parname value? ?-step value? ?-relstep value? ?-side value? ?-debugder -debugreltol value -debugabstol value?</span></div>
<h5 class='ruff'>Parameters</h5><table class='ruff_deflist'>
<tr><td><code><font color=#b9b96e>-debugabstol</font></code></td><td>Absolute error that controls printing of derivatives comparison if absolute error exceeds this value. Requires -debugder and -debugreltol.</td></tr>
<tr><td><code><font color=#b9b96e>-debugder</font></code></td><td>Switch to enable console debug logging of user-computed derivatives, as described above. Note that when debugging is enabled, then -side should be set to auto, right, left or both, depending on which numerical derivative you wish to compare to. Requires -debugreltol and -debugabstol values.</td></tr>
<tr><td><code><font color=#b9b96e>-debugreltol</font></code></td><td>Relative error that controls printing of derivatives comparison if relative error exceeds this value. Requires -debugder and -debugabstol.</td></tr>
<tr><td><code><font color=#b9b96e>-fixed</font></code></td><td>Specify that parameter is fixed during optimization, optional.</td></tr>
<tr><td><code><font color=#b9b96e>-lowlim</font></code></td><td>Specify lower limit for parameter, must be lower than upper limit if upper limit is provided, optional.</td></tr>
<tr><td><code><font color=#b9b96e>-parname</font></code></td><td>Parameter name, optional.</td></tr>
<tr><td><code><font color=#b9b96e>-relstep</font></code></td><td>The <em>relative</em> step size to be used in calculating the numerical derivatives. This number is the fractional size of the step, compared to the parameter value. This value supercedes the -step setting. If the parameter is zero, then a default step size is chosen.</td></tr>
<tr><td><code><font color=#b9b96e>-side</font></code></td><td>The sidedness of the finite difference when computing numerical derivatives. This field can take four values: auto : one-sided derivative computed automatically, right : one-sided derivative (f(x+h)-f(x))/h, left : one-sided derivative (f(x)-f(x-h))/h, both : two-sided derivative (f(x+h)-f(x-h))/(2*h), an : user-computed explicit derivatives, where h is the -step parameter described above. The &quot;automatic&quot; one-sided derivative method will chose a direction for the finite difference which does not violate any constraints. The other methods do not perform this check. The two-sided method is in principle more precise, but requires twice as many function evaluations. Default is auto.</td></tr>
<tr><td><code><font color=#b9b96e>-step</font></code></td><td>The step size to be used in calculating the numerical derivatives.  If set to zero, then the step size is computed automatically, optional.</td></tr>
<tr><td><code><font color=#b9b96e>-uplim</font></code></td><td>Specify upper limit for parameter, must be higher than lower limit if lower limit is provided, optional.</td></tr>
</table>
<h5 class='ruff'>Description</h5><p class='ruff'>Example of building list of 4 parameters with different constraints:</p>

<figure  class='ruff-snippet ruff-figure'><pre class='ruff'><b><font color=#ffa500>set</font></b> par0 [::tclopt::parCreate <font color=#b9b96e>-fixed</font>]
<b><font color=#ffa500>set</font></b> par1 [::tclopt::parCreate]
<b><font color=#ffa500>set</font></b> par2 [::tclopt::parCreate <font color=#b9b96e>-fixed</font>]
<b><font color=#ffa500>set</font></b> par3 [::tclopt::parCreate <font color=#b9b96e>-lowlim</font> -0.3 <font color=#b9b96e>-uplim</font> 0.2]
<b><font color=#ffa500>set</font></b> pars [<b><font color=#ffa500>list</font></b> <font color=#f1b479>$par0</font> <font color=#f1b479>$par1</font> <font color=#f1b479>$par2</font> <font color=#f1b479>$par3</font>]
</pre>

</figure><div class='ruff_source'><p class='ruff_source_link'><a id='l_tclopt_parCreate' href="javascript:toggleSource('tclopt_parCreate')">Show source</a></p>
<div id='tclopt_parCreate' class='ruff_dyn_src'><pre><b><font color=#fe6efe>proc</font></b> ::tclopt::parCreate {args} {

    <i><font color=#76a396># Creates input dictionary for [::tclopt::mpfit] procedure.</font></i>
    <i><font color=#76a396>#  -fixed - specify that parameter is fixed during optimization, optional</font></i>
    <i><font color=#76a396>#  -lowlim - specify lower limit for parameter, must be lower than upper limit if upper limit is provided, optional</font></i>
    <i><font color=#76a396>#  -uplim - specify upper limit for parameter, must be higher than lower limit if lower limit is provided, optional</font></i>
    <i><font color=#76a396>#  -parname - parameter name, optional</font></i>
    <i><font color=#76a396>#  -step - the step size to be used in calculating the numerical derivatives.  If set to zero, then the step size is</font></i>
    <i><font color=#76a396>#    computed automatically, optional</font></i>
    <i><font color=#76a396>#  -relstep - the *relative* step size to be used in calculating the numerical derivatives. This number is the</font></i>
    <i><font color=#76a396>#    fractional size of the step, compared to the parameter value. This value supercedes the -step setting.</font></i>
    <i><font color=#76a396>#    If the parameter is zero, then a default step size is chosen.</font></i>
    <i><font color=#76a396>#  -side - the sidedness of the finite difference when computing numerical derivatives. This field can take four</font></i>
    <i><font color=#76a396>#    values: auto : one-sided derivative computed automatically, right : one-sided derivative (f(x+h)-f(x))/h,</font></i>
    <i><font color=#76a396>#    left : one-sided derivative (f(x)-f(x-h))/h, both : two-sided derivative (f(x+h)-f(x-h))/(2*h), an :</font></i>
    <i><font color=#76a396>#    user-computed explicit derivatives, where h is the -step parameter described above. The &quot;automatic&quot; one-sided</font></i>
    <i><font color=#76a396>#    derivative method will chose a direction for the finite difference which does not violate any constraints. The</font></i>
    <i><font color=#76a396>#    other methods do not perform this check. The two-sided method is in principle more precise, but requires twice</font></i>
    <i><font color=#76a396>#    as many function evaluations. Default is auto.</font></i>
    <i><font color=#76a396>#  -debugder - switch to enable console debug logging of user-computed derivatives, as described above. Note that</font></i>
    <i><font color=#76a396>#    when debugging is enabled, then -side should be set to auto, right, left or both, depending on which numerical</font></i>
    <i><font color=#76a396>#    derivative you wish to compare to. Requires -debugreltol and -debugabstol values.</font></i>
    <i><font color=#76a396>#  -debugreltol - relative error that controls printing of derivatives comparison if relative error exceeds this</font></i>
    <i><font color=#76a396>#    value. Requires -debugder and -debugabstol.</font></i>
    <i><font color=#76a396>#  -debugabstol - absolute error that controls printing of derivatives comparison if absolute error exceeds this</font></i>
    <i><font color=#76a396>#    value. Requires -debugder and -debugreltol.</font></i>
    <i><font color=#76a396># Synopsis: ?-fixed? ?-lowlim value? ?-uplim value? ?-parname value? ?-step value? ?-relstep value? ?-side value?</font></i>
    <i><font color=#76a396>#   ?-debugder -debugreltol value -debugabstol value?</font></i>
    <i><font color=#76a396>#</font></i>
    <i><font color=#76a396># Example of building list of 4 parameters with different constraints:</font></i>
    <i><font color=#76a396># ```</font></i>
    <i><font color=#76a396># set par0 [::tclopt::parCreate -fixed]</font></i>
    <i><font color=#76a396># set par1 [::tclopt::parCreate]</font></i>
    <i><font color=#76a396># set par2 [::tclopt::parCreate -fixed]</font></i>
    <i><font color=#76a396># set par3 [::tclopt::parCreate -lowlim -0.3 -uplim 0.2]</font></i>
    <i><font color=#76a396># set pars [list $par0 $par1 $par2 $par3]</font></i>
    <i><font color=#76a396># ```</font></i>
    argparse {
        {<font color=#b9b96e>-fixed</font> <font color=#b9b96e>-boolean</font>}
        <font color=#b9b96e>-lowlim</font>=
        <font color=#b9b96e>-uplim</font>=
        <font color=#b9b96e>-parname</font>=
        <font color=#b9b96e>-step</font>=
        <font color=#b9b96e>-relstep</font>=
        {<font color=#b9b96e>-side</font>= <font color=#b9b96e>-enum</font> {auto right left both an} <font color=#b9b96e>-default</font> auto}
        {<font color=#b9b96e>-debugder</font> <font color=#b9b96e>-require</font> {debugreltol debugabstol}}
        {<font color=#b9b96e>-debugreltol</font>= <font color=#b9b96e>-require</font> debugder}
        {<font color=#b9b96e>-debugabstol</font>= <font color=#b9b96e>-require</font> debugder}
    }
    <b><font color=#ffa500>set</font></b> sideMap [<b><font color=#ffa500>dict</font></b> create auto 0 right 1 left -1 both 2 an 3]
    <b><font color=#ffa500>set</font></b> params [<b><font color=#ffa500>dict</font></b> create fixed <font color=#f1b479>$fixed</font>]
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists lowlim]} {
        dappend params limited 1
        dappend params limits <font color=#f1b479>$lowlim</font>
    } <b><font color=#ffa500>else</font></b> {
        dappend params limited 0
        dappend params limits 0
    }
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists uplim]} {
        <b><font color=#ffa500>dict</font></b> lappend params limited 1
        <b><font color=#ffa500>dict</font></b> lappend params limits <font color=#f1b479>$uplim</font>
    } <b><font color=#ffa500>else</font></b> {
        <b><font color=#ffa500>dict</font></b> lappend params limited 0
        <b><font color=#ffa500>dict</font></b> lappend params limits 0
    }
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists parname]} {
        dappend params parname <font color=#f1b479>$parname</font>
    } <b><font color=#ffa500>else</font></b> {
        dappend params parname <font color=#90ee90>&quot;&quot;</font>
    }
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists step]} {
        dappend params step <font color=#f1b479>$step</font>
    } <b><font color=#ffa500>else</font></b> {
        dappend params step 0
    }
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists relstep]} {
        dappend params relstep <font color=#f1b479>$relstep</font>
    } <b><font color=#ffa500>else</font></b> {
        dappend params relstep 0
    }
    dappend params side [<b><font color=#ffa500>dict</font></b> get <font color=#f1b479>$sideMap</font> <font color=#f1b479>$side</font>]
    <b><font color=#ffa500>if</font></b> {[<b><font color=#ffa500>info</font></b> exists debugder]} {
        dappend params deriv_debug 1
        dappend params deriv_reltol <font color=#f1b479>$debugreltol</font>
        dappend params deriv_abstol <font color=#f1b479>$debugabstol</font>
    } <b><font color=#ffa500>else</font></b> {
        dappend params deriv_debug 0
        dappend params deriv_reltol 0
        dappend params deriv_abstol 0
    }
    <b><font color=#fe6efe>return</font></b> <font color=#f1b479>$params</font>
}</pre></div>
</div></main><nav class='ruff-nav'><ul ><li class='ruff-toc1'><a style='padding-top:2px;' href='index.html'>Start page</a></li>
<li class='ruff-toc1'><a href='index-docindex.html' accesskey='i'>Index</a></li>
<hr>
<li class='ruff-toc1'><a href='index-Examples.html'>Examples</a></li>
<li class='ruff-toc1'><a class='ruff-highlight' href='index-tclopt.html'>tclopt</a></li>
<hr><li class='ruff-toc2'><a href='#::tclopt-Commands'>Commands</a></li><li class='ruff-toc3 ruff-tip'><a href='index-tclopt.html#::tclopt::mpfit'>mpfit</a><span class='ruff-tiptext'><pre>&lt;span class='ruff_cmd'&gt;mpfit&lt;/span&gt; &lt;span class='ruff_arg'&gt;<font color=#b9b96e>-funct</font> value <font color=#b9b96e>-m</font> value <font color=#b9b96e>-xall</font> list <font color=#b9b96e>-pdata</font> value ?-pars list? ?-ftol value? ?-xtol value? ?-gtol value? ?-stepfactor value? ?-covtol value? ?-maxiter value? ?-maxfev value? ?-epsfcn value? ?-nofinitecheck?&lt;/span&gt;</pre>Does least squares fitting using modified Levenberg-Marquardt algorithm.
</span></li><li class='ruff-toc3 ruff-tip'><a href='index-tclopt.html#::tclopt::parCreate'>parCreate</a><span class='ruff-tiptext'><pre>&lt;span class='ruff_cmd'&gt;parCreate&lt;/span&gt; &lt;span class='ruff_arg'&gt;?-fixed? ?-lowlim value? ?-uplim value? ?-parname value? ?-step value? ?-relstep value? ?-side value? ?-debugder <font color=#b9b96e>-debugreltol</font> value <font color=#b9b96e>-debugabstol</font> value?&lt;/span&gt;</pre>Creates input dictionary for <a href="index-tclopt.html#::tclopt::mpfit" title="mpfit" class='ruff_cmd'>mpfit</a> procedure.
</span></li></ul></nav><footer class='ruff-layout-footer ruff-ft'><div style='float: right;'>Document generated by <a href='https://ruff.magicsplat.com'>Ruff!</a></div><div>&copy; George Yashin</div></footer>
</div></body></html>
